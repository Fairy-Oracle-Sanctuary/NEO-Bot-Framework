# NEO Bot Framework

> ğŸŒ å®˜ç½‘: [https://neobot.k2cro4.my/](https://neobot.k2cro4.my/)

## ğŸ“– æ¦‚è¿°

NEO æ˜¯ä¸€ä¸ªåŸºäº Python çš„ç°ä»£åŒ– OneBot 11 åè®®æœºå™¨äººæ¡†æ¶ï¼Œä¸“ä¸ºéœ€è¦é«˜æ€§èƒ½ã€å¯æ‰©å±•æ€§å’Œå¼€å‘æ•ˆç‡çš„å›¢é˜Ÿè®¾è®¡ã€‚è¯¥æ¡†æ¶é€šè¿‡ WebSocket ä¸å„ç§ OneBot å®ç°ç«¯ï¼ˆå¦‚ NapCatQQã€LLOneBot ç­‰ï¼‰é€šä¿¡ï¼Œæä¾›äº†ä¸€å¥—å®Œæ•´çš„æœºå™¨äººå¼€å‘è§£å†³æ–¹æ¡ˆã€‚

### è®¾è®¡ç†å¿µ

NEO æ¡†æ¶çš„è®¾è®¡éµå¾ªä»¥ä¸‹æ ¸å¿ƒç†å¿µï¼š

1.  **å¼€å‘è€…å‹å¥½**ï¼šç®€æ´çš„ API è®¾è®¡ã€å®Œæ•´çš„ç±»å‹æç¤ºå’Œè¯¦ç»†çš„æ–‡æ¡£ï¼Œè®©å¼€å‘è€…èƒ½å¤Ÿå¿«é€Ÿä¸Šæ‰‹å’Œé«˜æ•ˆå¼€å‘
2.  **æ¶æ„æ¸…æ™°**ï¼šé‡‡ç”¨æ¨¡å—åŒ–è®¾è®¡ï¼Œåˆ†ç¦»å…³æ³¨ç‚¹ï¼Œä½¿ä»£ç æ˜“äºç»´æŠ¤å’Œæ‰©å±•
3.  **é«˜æ€§èƒ½å¼‚æ­¥**ï¼šåŸºäº `asyncio` å’Œ `websockets` æ„å»ºï¼Œæ”¯æŒé«˜å¹¶å‘æ¶ˆæ¯å¤„ç†
4.  **ç±»å‹å®‰å…¨**ï¼šå…¨é¢ä½¿ç”¨ Python ç±»å‹ç³»ç»Ÿï¼Œæä¾›ç¼–è¯‘æ—¶ç±»å‹æ£€æŸ¥ï¼Œå‡å°‘è¿è¡Œæ—¶é”™è¯¯
5.  **çƒ­é‡è½½æ”¯æŒ**ï¼šæ”¯æŒæ’ä»¶çƒ­é‡è½½ï¼Œå¼€å‘è¿‡ç¨‹ä¸­ä¿®æ”¹ä»£ç æ— éœ€é‡å¯æœºå™¨äºº

### æ ¸å¿ƒä»·å€¼

- **å¿«é€ŸåŸå‹å¼€å‘**ï¼šé€šè¿‡ç®€æ´çš„è£…é¥°å™¨è¯­æ³•å¿«é€Ÿå®šä¹‰æŒ‡ä»¤å’Œäº‹ä»¶å¤„ç†å™¨
- **ç”Ÿäº§ç¯å¢ƒå°±ç»ª**ï¼šå†…ç½®æ–­çº¿é‡è¿ã€é”™è¯¯å¤„ç†å’Œæ€§èƒ½ç›‘æ§æœºåˆ¶
- **å¯æ‰©å±•æ¶æ„**ï¼šæ”¯æŒè‡ªå®šä¹‰æ’ä»¶ã€ä¸­é—´ä»¶å’Œæƒé™ç³»ç»Ÿ
- **ç°ä»£åŒ–å¼€å‘ä½“éªŒ**ï¼šæ”¯æŒçƒ­é‡è½½ã€ç±»å‹æç¤ºå’Œå®Œæ•´çš„ API æ–‡æ¡£

### é€‚ç”¨åœºæ™¯

- QQ ç¾¤æœºå™¨äººç®¡ç†
- è‡ªåŠ¨åŒ–å®¢æœä¸é—®ç­”ç³»ç»Ÿ
- æ¸¸æˆç¤¾åŒºç®¡ç†
- å›¢é˜Ÿå†…éƒ¨å·¥å…·é›†æˆ
- æ•™è‚²ä¸åŸ¹è®­è¾…åŠ©

## âœ¨ ç‰¹æ€§

*   **OneBot 11 æ ‡å‡†æ”¯æŒ**ï¼šå®Œæ•´æ”¯æŒ OneBot 11 çš„æ¶ˆæ¯ã€é€šçŸ¥ã€è¯·æ±‚å’Œå…ƒäº‹ä»¶ã€‚
*   **ç±»å‹å®‰å…¨**ï¼šåŸºäº `dataclasses` çš„å¼ºç±»å‹äº‹ä»¶æ¨¡å‹ï¼Œå¼€å‘ä½“éªŒæ›´ä½³ã€‚
*   **æ’ä»¶ç³»ç»Ÿ**ï¼šè½»é‡çº§çš„è£…é¥°å™¨é£æ ¼æ’ä»¶ç³»ç»Ÿï¼Œæ”¯æŒæŒ‡ä»¤ (`@matcher.command`) å’Œäº‹ä»¶ç›‘å¬ (`@matcher.on_notice`, `@matcher.on_request`)ã€‚
*   **æ’ä»¶å…ƒæ•°æ®ä¸å†…ç½®å¸®åŠ©**ï¼šæ’ä»¶å¯é€šè¿‡ `__plugin_meta__` å˜é‡è¿›è¡Œè‡ªæˆ‘æè¿°ã€‚æ¡†æ¶æ ¸å¿ƒå†…ç½®äº† `/help` æŒ‡ä»¤ï¼Œå¯è‡ªåŠ¨æ”¶é›†å¹¶å±•ç¤ºæ‰€æœ‰æ’ä»¶çš„å¸®åŠ©ä¿¡æ¯ï¼Œæ— éœ€æ‰‹åŠ¨ç»´æŠ¤ã€‚
*   **ğŸ”¥ çƒ­é‡è½½æ”¯æŒ**ï¼šå†…ç½®æ–‡ä»¶ç›‘æ§ï¼Œä¿®æ”¹ `plugins` ä¸‹çš„ä»£ç è‡ªåŠ¨é‡è½½ï¼Œæ— éœ€é‡å¯ï¼Œæå¤§æå‡è°ƒè¯•æ•ˆç‡ã€‚
*   **å¼‚æ­¥æ ¸å¿ƒ**ï¼šåŸºäº `asyncio` å’Œ `websockets` çš„é«˜æ€§èƒ½å¼‚æ­¥æ ¸å¿ƒã€‚
*   **è‡ªåŠ¨é‡è¿**ï¼šå†…ç½® WebSocket æ–­çº¿é‡è¿æœºåˆ¶ã€‚

## âš¡ï¸ æ€§èƒ½ä¼˜åŒ–

### Redis ç¼“å­˜æœºåˆ¶
ä¸ºäº†æå‡å“åº”é€Ÿåº¦å¹¶å‡å°‘å¯¹ OneBot API çš„é‡å¤è°ƒç”¨ï¼Œæ¡†æ¶æ ¸å¿ƒé›†æˆäº†ä¸€å¥—åŸºäº Redis çš„ç¼“å­˜ç³»ç»Ÿã€‚å¯¹äºä¸€äº›ä¸é¢‘ç¹å˜æ›´çš„æ•°æ®ï¼ˆå¦‚ç¾¤ä¿¡æ¯ã€å¥½å‹åˆ—è¡¨ç­‰ï¼‰ï¼Œé¦–æ¬¡æŸ¥è¯¢åä¼šå°†å…¶ç¼“å­˜è‡³ Redisï¼Œåœ¨ç¼“å­˜æœ‰æ•ˆæœŸå†…ï¼ˆé»˜è®¤ä¸º 1 å°æ—¶ï¼‰ï¼Œåç»­è¯·æ±‚å°†ç›´æ¥ä» Redis è¯»å–ï¼Œæå¤§æå‡äº†æ€§èƒ½ã€‚

#### å·¥ä½œåŸç†
- **è‡ªåŠ¨ç¼“å­˜**ï¼šæ¡†æ¶ä¼šè‡ªåŠ¨ç¼“å­˜ç‰¹å®š API çš„è°ƒç”¨ç»“æœã€‚
- **ç¼“å­˜é”®**ï¼šç¼“å­˜é”®æ ¹æ® API åç§°å’Œå…³é”®å‚æ•°ï¼ˆå¦‚ `group_id`, `user_id`ï¼‰ç”Ÿæˆï¼Œç¡®ä¿å”¯ä¸€æ€§ã€‚
- **è¿‡æœŸæ—¶é—´**ï¼šé»˜è®¤ç¼“å­˜ 1 å°æ—¶ï¼Œä¹‹åä¼šè‡ªåŠ¨å¤±æ•ˆï¼Œä¸‹æ¬¡è°ƒç”¨æ—¶å°†é‡æ–°ä» OneBot å®ç°ç«¯è·å–æœ€æ–°æ•°æ®ã€‚

#### å—å½±å“çš„ API
ä»¥ä¸‹æ ¸å¿ƒ API å·²é»˜è®¤å¯ç”¨ç¼“å­˜ï¼š
- `get_group_info`
- `get_group_member_info`
- `get_friend_list`
- `get_stranger_info`
- `get_login_info`

#### å¦‚ä½•ç»•è¿‡ç¼“å­˜
åœ¨æŸäº›åœºæ™¯ä¸‹ï¼Œä½ å¯èƒ½éœ€è¦è·å–å®æ—¶æ•°æ®è€Œéç¼“å­˜æ•°æ®ã€‚ä¸ºæ­¤ï¼Œæ‰€æœ‰å—ç¼“å­˜å½±å“çš„ API æ–¹æ³•éƒ½å¢åŠ äº†ä¸€ä¸ª `no_cache: bool = False` çš„å¯é€‰å‚æ•°ã€‚

å½“ä½ éœ€è¦å¼ºåˆ¶ä»æœåŠ¡å™¨è·å–æœ€æ–°ä¿¡æ¯æ—¶ï¼Œåªéœ€åœ¨è°ƒç”¨æ—¶ä¼ å…¥ `no_cache=True` å³å¯ã€‚

**ç¤ºä¾‹ï¼š**
```python
# æ­£å¸¸è°ƒç”¨ï¼Œä¼šä½¿ç”¨ç¼“å­˜
group_info = await bot.get_group_info(group_id=12345)

# å¼ºåˆ¶è·å–æœ€æ–°ä¿¡æ¯ï¼Œä¸ä½¿ç”¨ç¼“å­˜
latest_group_info = await bot.get_group_info(group_id=12345, no_cache=True)
```

### `__slots__` å†…å­˜ä¼˜åŒ–
æ¡†æ¶å†…çš„æ‰€æœ‰æ•°æ®æ¨¡å‹ï¼ˆåŒ…æ‹¬äº‹ä»¶ã€æ¶ˆæ¯æ®µã€API è¿”å›å¯¹è±¡ç­‰ï¼‰å‡å·²å¯ç”¨ `__slots__ = True` ä¼˜åŒ–ã€‚è¿™å¯ä»¥æ˜¾è‘—å‡å°‘æ¯ä¸ªå¯¹è±¡å®ä¾‹çš„å†…å­˜å ç”¨ï¼Œç‰¹åˆ«æ˜¯åœ¨å¤„ç†å¤§é‡äº‹ä»¶å’Œæ•°æ®æ—¶ï¼Œèƒ½å¤Ÿæœ‰æ•ˆé™ä½æœºå™¨äººçš„æ•´ä½“å†…å­˜æ¶ˆè€—ã€‚


## ğŸ“ å¾…åŠäº‹é¡¹ (TODO)

### API å°è£…
- [x] **æ¶ˆæ¯ç›¸å…³**
    - `delete_msg`: æ’¤å›æ¶ˆæ¯
    - `get_msg`: è·å–æ¶ˆæ¯
    - `get_forward_msg`: è·å–åˆå¹¶è½¬å‘æ¶ˆæ¯
    - `send_like`: å‘é€ç‚¹èµ
- [x] **ç¾¤ç»„ç®¡ç†**
    - `set_group_kick`: ç¾¤ç»„è¸¢äºº
    - `set_group_ban`: ç¾¤ç»„å•äººç¦è¨€
    - `set_group_anonymous_ban`: ç¾¤ç»„åŒ¿åç¦è¨€
    - `set_group_whole_ban`: ç¾¤ç»„å…¨å‘˜ç¦è¨€
    - `set_group_admin`: ç¾¤ç»„è®¾ç½®ç®¡ç†å‘˜
    - `set_group_anonymous`: ç¾¤ç»„åŒ¿å
    - `set_group_card`: è®¾ç½®ç¾¤åç‰‡ï¼ˆç¾¤å¤‡æ³¨ï¼‰
    - `set_group_name`: è®¾ç½®ç¾¤å
    - `set_group_leave`: é€€å‡ºç¾¤ç»„
    - `set_group_special_title`: è®¾ç½®ç¾¤ç»„ä¸“å±å¤´è¡”
- [x] **ç¾¤ç»„ä¿¡æ¯**
    - `get_group_info`: è·å–ç¾¤ä¿¡æ¯
    - `get_group_list`: è·å–ç¾¤åˆ—è¡¨
    - `get_group_member_info`: è·å–ç¾¤æˆå‘˜ä¿¡æ¯
    - `get_group_member_list`: è·å–ç¾¤æˆå‘˜åˆ—è¡¨
    - `get_group_honor_info`: è·å–ç¾¤è£èª‰ä¿¡æ¯
- [x] **ç”¨æˆ·ç›¸å…³**
    - `get_login_info`: è·å–ç™»å½•å·ä¿¡æ¯
    - `get_stranger_info`: è·å–é™Œç”Ÿäººä¿¡æ¯
    - `get_friend_list`: è·å–å¥½å‹åˆ—è¡¨
- [x] **è¯·æ±‚å¤„ç†**
    - `set_friend_add_request`: å¤„ç†åŠ å¥½å‹è¯·æ±‚
    - `set_group_add_request`: å¤„ç†åŠ ç¾¤è¯·æ±‚/é‚€è¯·
- [x] **ç³»ç»Ÿ/å…¶ä»–**
    - `get_version_info`: è·å–ç‰ˆæœ¬ä¿¡æ¯
    - `get_status`: è·å–çŠ¶æ€
    - `can_send_image`: æ£€æŸ¥æ˜¯å¦å¯ä»¥å‘é€å›¾ç‰‡
    - `can_send_record`: æ£€æŸ¥æ˜¯å¦å¯ä»¥å‘é€è¯­éŸ³
    - `clean_cache`: æ¸…ç†ç¼“å­˜

### å¾…å®ç° API
- [ ] **Web å‡­è¯ç±»**
    - `get_cookies`
    - `get_csrf_token`
    - `get_credentials`
- [ ] **æ–‡ä»¶/èµ„æºä¿¡æ¯**
    - `get_image`
    - `get_record`
    - `get_file`
- [ ] **ç³»ç»Ÿæ§åˆ¶**
    - `set_restart`
- [ ] **æ‰©å±•åŠŸèƒ½**
    - [x] `send_forward_msg`: å‘é€åˆå¹¶è½¬å‘æ¶ˆæ¯

### å…¶ä»–æ”¹è¿›
- [x] **API å¼ºç±»å‹å°è£…**: å°† API è¿”å›å€¼ä» `dict` è½¬æ¢ä¸ºæ•°æ®æ¨¡å‹å¯¹è±¡ã€‚
- [x] **Redis æ”¯æŒ**: é›†æˆ Redis è¿æ¥æ± ï¼Œä¾¿äºæ’ä»¶å¤ç”¨è¿æ¥ã€‚
- [x] **æƒé™ç³»ç»Ÿ**: å®ç°åŸºç¡€çš„æƒé™ç®¡ç†ï¼ˆè¶…çº§ç®¡ç†å‘˜ã€ç¾¤ç®¡ç†å‘˜ç­‰ï¼‰ã€‚
- [x] **æ—¥å¿—ç³»ç»Ÿä¼˜åŒ–**: å¼•å…¥ `loguru` è¿›è¡Œæ—¥å¿—è®°å½•ï¼Œæ”¯æŒæ–‡ä»¶è¾“å‡ºå’Œæ—¥å¿—çº§åˆ«æ§åˆ¶ã€‚
- [x] **å¼‚å¸¸å¤„ç†å¢å¼º**: å¢å¼ºæ’ä»¶æ‰§è¡Œè¿‡ç¨‹ä¸­çš„å¼‚å¸¸æ•è·ï¼Œé˜²æ­¢å•ä¸ªæ’ä»¶å´©æºƒå½±å“æ•´ä¸ª Botã€‚
- [x] **ä¸­é—´ä»¶æ”¯æŒ**: æ·»åŠ æ¶ˆæ¯å¤„ç†ä¸­é—´ä»¶ï¼Œæ”¯æŒåœ¨æŒ‡ä»¤æ‰§è¡Œå‰/åè¿›è¡Œæ‹¦æˆªå’Œå¤„ç†ã€‚

## ğŸ“‚ é¡¹ç›®ç»“æ„

```
.
â”œâ”€â”€ plugins/                # æ’ä»¶ç›®å½•ï¼Œæ–°å»ºæ’ä»¶æ–‡ä»¶å³å¯è‡ªåŠ¨åŠ è½½ï¼ˆæ”¯æŒçƒ­é‡è½½ï¼‰
â”‚   â”œâ”€â”€ admin.py            # ç®¡ç†å‘˜æ’ä»¶
â”‚   â””â”€â”€ echo.py             # ç¤ºä¾‹æ’ä»¶ï¼šå®ç° /echo å’Œ /èµæˆ‘ æŒ‡ä»¤
â”œâ”€â”€ core/                   # æ ¸å¿ƒæ¡†æ¶ä»£ç 
â”‚   â”œâ”€â”€ api/                # API æ¨¡å—æŠ½è±¡å±‚
â”‚   â”œâ”€â”€ bot.py              # Bot å®ä¾‹ä¸ API å°è£…
â”‚   â”œâ”€â”€ admin_manager.py    # ç®¡ç†å‘˜ç®¡ç†æ¨¡å—
â”‚   â”œâ”€â”€ command_manager.py  # å‘½ä»¤ä¸äº‹ä»¶åˆ†å‘å™¨
â”‚   â”œâ”€â”€ config_loader.py    # é…ç½®åŠ è½½å™¨
â”‚   â”œâ”€â”€ event_handler.py    # äº‹ä»¶å¤„ç†å™¨
â”‚   â”œâ”€â”€ executor.py         # æ’ä»¶æ‰§è¡Œå™¨
â”‚   â”œâ”€â”€ logger.py           # æ—¥å¿—ç³»ç»Ÿ
â”‚   â”œâ”€â”€ permission_manager.py # æƒé™ç®¡ç†å™¨
â”‚   â”œâ”€â”€ plugin_manager.py   # æ’ä»¶åŠ è½½ä¸ç®¡ç†
â”‚   â”œâ”€â”€ redis_manager.py    # Redis è¿æ¥ç®¡ç†å™¨
â”‚   â””â”€â”€ ws.py               # WebSocket å®¢æˆ·ç«¯æ ¸å¿ƒ
â”œâ”€â”€ data/                   # æ•°æ®å­˜å‚¨ç›®å½•
â”‚   â”œâ”€â”€ admin.json          # ç®¡ç†å‘˜é…ç½®æ–‡ä»¶
â”‚   â””â”€â”€ permissions.json    # æƒé™æ•°æ®
â”œâ”€â”€ models/                 # æ•°æ®æ¨¡å‹
â”‚   â”œâ”€â”€ events/             # OneBot äº‹ä»¶å®šä¹‰
â”‚   â”œâ”€â”€ message.py          # æ¶ˆæ¯æ®µå®šä¹‰
â”‚   â”œâ”€â”€ objects.py          # API è¿”å›å¯¹è±¡å®šä¹‰
â”‚   â””â”€â”€ sender.py           # å‘é€è€…å®šä¹‰
â”œâ”€â”€ .gitignore
â”œâ”€â”€ config.toml             # é…ç½®æ–‡ä»¶
â”œâ”€â”€ main.py                 # å¯åŠ¨å…¥å£ï¼ˆåŒ…å«çƒ­é‡è½½ç›‘æ§ï¼‰
â””â”€â”€ requirements.txt        # é¡¹ç›®ä¾èµ–
```

### ç›®å½•ç»“æ„è¯¦ç»†è¯´æ˜

#### `plugins/` - æ’ä»¶ç›®å½•
- **åŠŸèƒ½**ï¼šå­˜æ”¾æ‰€æœ‰æœºå™¨äººæ’ä»¶ï¼Œæ”¯æŒçƒ­é‡è½½æœºåˆ¶
- **åŠ è½½æœºåˆ¶**ï¼šæ¡†æ¶ä¼šè‡ªåŠ¨æ‰«ææ­¤ç›®å½•ä¸‹çš„æ‰€æœ‰ `.py` æ–‡ä»¶ï¼Œå¹¶ä½œä¸ºæ’ä»¶åŠ è½½
- **æ’ä»¶çº¦å®š**ï¼šæ¯ä¸ªæ’ä»¶æ–‡ä»¶åº”åŒ…å« `__plugin_meta__` å­—å…¸ç”¨äºæ’ä»¶å…ƒæ•°æ®å®šä¹‰
- **çƒ­é‡è½½**ï¼šå¼€å‘è¿‡ç¨‹ä¸­ä¿®æ”¹æ’ä»¶æ–‡ä»¶ä¼šè‡ªåŠ¨è§¦å‘é‡è½½ï¼Œæ— éœ€é‡å¯æœºå™¨äºº
- **å†…ç½®æ’ä»¶**ï¼š
  - `admin.py` - ç®¡ç†å‘˜ç®¡ç†æ’ä»¶ï¼Œæ”¯æŒåŠ¨æ€æ·»åŠ /ç§»é™¤ç®¡ç†å‘˜
  - `echo.py` - ç¤ºä¾‹æ’ä»¶ï¼Œæ¼”ç¤ºåŸºæœ¬æŒ‡ä»¤å¤„ç†

#### `core/` - æ ¸å¿ƒæ¡†æ¶ä»£ç 
- `api/` - API æ¨¡å—æŠ½è±¡å±‚
  - `base.py` - API åŸºç±»å®šä¹‰
  - `message.py` - æ¶ˆæ¯ç›¸å…³ API å°è£…
  - `group.py` - ç¾¤ç»„ç®¡ç† API å°è£…
  - `friend.py` - å¥½å‹ç›¸å…³ API å°è£…
  - `account.py` - è´¦å·ç›¸å…³ API å°è£…
- `bot.py` - Bot æ ¸å¿ƒç±»ï¼Œé€šè¿‡ Mixin æ¨¡å¼ç»§æ‰¿æ‰€æœ‰ API åŠŸèƒ½ï¼Œæä¾›ç»Ÿä¸€çš„è°ƒç”¨æ¥å£
  - `admin_manager.py` - ç®¡ç†å‘˜ç®¡ç†æ¨¡å—ï¼Œè´Ÿè´£ç®¡ç†å‘˜çš„æ·»åŠ ã€ç§»é™¤å’Œæƒé™éªŒè¯
  - `command_manager.py` - å‘½ä»¤ä¸äº‹ä»¶åˆ†å‘å™¨ï¼Œè´Ÿè´£æ³¨å†Œå’Œå¤„ç†æ‰€æœ‰æŒ‡ä»¤å’Œäº‹ä»¶
- `config_loader.py` - é…ç½®åŠ è½½å™¨ï¼Œè¯»å–å’Œè§£æ `config.toml` é…ç½®æ–‡ä»¶
- `event_handler.py` - äº‹ä»¶å¤„ç†å™¨ï¼Œè´Ÿè´£å°†åŸå§‹äº‹ä»¶è½¬æ¢ä¸ºç±»å‹åŒ–äº‹ä»¶å¯¹è±¡
- `executor.py` - æ’ä»¶æ‰§è¡Œå™¨ï¼Œæä¾›çº¿ç¨‹æ± æ‰§è¡Œç¯å¢ƒç”¨äºæ‰§è¡ŒåŒæ­¥ä»»åŠ¡
- `logger.py` - æ—¥å¿—ç³»ç»Ÿï¼ŒåŸºäº `loguru` æä¾›é«˜æ€§èƒ½æ—¥å¿—è®°å½•
- `permission_manager.py` - æƒé™ç®¡ç†å™¨ï¼Œç®¡ç†ç”¨æˆ·æƒé™çº§åˆ«ï¼ˆadminã€opã€userï¼‰
- `plugin_manager.py` - æ’ä»¶åŠ è½½ä¸ç®¡ç†ï¼Œè´Ÿè´£æ’ä»¶çš„æ‰«æã€åŠ è½½å’Œçƒ­é‡è½½
- `redis_manager.py` - Redis è¿æ¥ç®¡ç†å™¨ï¼Œæä¾›å¼‚æ­¥ Redis å®¢æˆ·ç«¯è¿æ¥æ± 
- `ws.py` - WebSocket å®¢æˆ·ç«¯æ ¸å¿ƒï¼Œè´Ÿè´£ä¸ OneBot å®ç°ç«¯å»ºç«‹å’Œç®¡ç†è¿æ¥

#### `data/` - æ•°æ®å­˜å‚¨ç›®å½•
- `admin.json` - ç®¡ç†å‘˜é…ç½®æ–‡ä»¶ï¼Œå­˜å‚¨å…¨å±€ç®¡ç†å‘˜åˆ—è¡¨
- `permissions.json` - æƒé™æ•°æ®æ–‡ä»¶ï¼Œå­˜å‚¨ç”¨æˆ·æƒé™æ˜ å°„å…³ç³»


#### `models/` - æ•°æ®æ¨¡å‹å®šä¹‰
- `events/` - OneBot äº‹ä»¶å®šä¹‰
  - `base.py` - äº‹ä»¶åŸºç±»å®šä¹‰
  - `message.py` - æ¶ˆæ¯äº‹ä»¶å®šä¹‰
  - `notice.py` - é€šçŸ¥äº‹ä»¶å®šä¹‰
  - `request.py` - è¯·æ±‚äº‹ä»¶å®šä¹‰
  - `meta.py` - å…ƒäº‹ä»¶å®šä¹‰
  - `factory.py` - äº‹ä»¶å·¥å‚ç±»ï¼Œç”¨äºæ ¹æ® JSON æ•°æ®åˆ›å»ºå¯¹åº”äº‹ä»¶å¯¹è±¡
- `message.py` - æ¶ˆæ¯æ®µå®šä¹‰ï¼Œæ”¯æŒæ–‡æœ¬ã€å›¾ç‰‡ã€è¡¨æƒ…ç­‰å¤šç§æ¶ˆæ¯ç±»å‹
- `objects.py` - API è¿”å›å¯¹è±¡å®šä¹‰ï¼Œæä¾›å¼ºç±»å‹åŒ–çš„ API å“åº”æ•°æ®æ¨¡å‹
- `sender.py` - å‘é€è€…å®šä¹‰ï¼ŒåŒ…å«ç”¨æˆ·ã€ç¾¤æˆå‘˜ç­‰ä¿¡æ¯

#### æ ¹ç›®å½•æ–‡ä»¶
- `.gitignore` - Git å¿½ç•¥æ–‡ä»¶é…ç½®
- `config.toml` - ä¸»é…ç½®æ–‡ä»¶ï¼ŒåŒ…å« WebSocket è¿æ¥ã€æœºå™¨äººæŒ‡ä»¤å‰ç¼€ã€Redis è¿æ¥ç­‰é…ç½®
- `main.py` - ç¨‹åºå…¥å£æ–‡ä»¶ï¼Œè´Ÿè´£åˆå§‹åŒ–æ’ä»¶ã€å¯åŠ¨çƒ­é‡è½½ç›‘æ§å’Œå»ºç«‹ WebSocket è¿æ¥
- `requirements.txt` - Python ä¾èµ–åŒ…åˆ—è¡¨

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. ç¯å¢ƒå‡†å¤‡

*   Python 3.8+
*   OneBot 11 å®ç°ç«¯ï¼ˆæ¨è [NapCatQQ](https://github.com/NapNeko/NapCatQQ) æˆ– LLOneBotï¼‰

### 2. å®‰è£…ä¾èµ–

```bash
pip install -r requirements.txt
```

### 3. é…ç½®æ–‡ä»¶

ä¿®æ”¹æ ¹ç›®å½•ä¸‹çš„ `config.toml`ï¼Œé…ç½® WebSocket è¿æ¥ä¿¡æ¯ï¼š

```toml
[napcat_ws]
uri = "ws://127.0.0.1:30004"  # OneBot å®ç°ç«¯çš„ WebSocket åœ°å€
token = "your_token"          # Access Token (å¦‚æœæœ‰)
reconnect_interval = 5        # æ–­çº¿é‡è¿é—´éš”ï¼ˆç§’ï¼‰

[bot]
command = ["/"]               # æŒ‡ä»¤å‰ç¼€ï¼Œæ”¯æŒå¤šä¸ªï¼Œå¦‚ ["/", "#"]
```

### 4. è¿è¡Œ

```bash
python main.py
```

## ğŸ› ï¸ å¼€å‘æŒ‡å—

### ğŸ”¥ çƒ­é‡è½½è°ƒè¯•

é¡¹ç›®é›†æˆäº† `watchdog` æ–‡ä»¶ç›‘æ§ã€‚åœ¨å¼€å‘è¿‡ç¨‹ä¸­ï¼Œä½ åªéœ€è¦ï¼š
1.  ä¿æŒ `main.py` è¿è¡Œã€‚
2.  ä¿®æ”¹æˆ–æ–°å»º `plugins` ç›®å½•ä¸‹çš„ `.py` æ’ä»¶æ–‡ä»¶ã€‚
3.  ä¿å­˜æ–‡ä»¶ã€‚
4.  æ§åˆ¶å°ä¼šè‡ªåŠ¨æç¤º `[HotReload] æ’ä»¶é‡è½½å®Œæˆ`ï¼Œæ–°çš„é€»è¾‘ç«‹å³ç”Ÿæ•ˆã€‚

### åˆ›å»ºæ–°æ’ä»¶

åœ¨ `plugins` ç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ªæ–°çš„ `.py` æ–‡ä»¶ï¼ˆä¾‹å¦‚ `my_plugin.py`ï¼‰ï¼Œæ¡†æ¶ä¼šè‡ªåŠ¨åŠ è½½å®ƒã€‚

### ç¤ºä¾‹ä»£ç 

#### 1. æ³¨å†Œæ¶ˆæ¯æŒ‡ä»¤

ä½¿ç”¨ `@matcher.command("æŒ‡ä»¤å")` æ³¨å†ŒæŒ‡ä»¤ã€‚

```python
from core.command_manager import matcher
from core.bot import Bot
from models import MessageEvent

# æ³¨å†Œ /hello æŒ‡ä»¤
@matcher.command("hello")
async def handle_hello(bot: Bot, event: MessageEvent, args: list[str]):
    # args æ˜¯å»é™¤æŒ‡ä»¤åçš„å‚æ•°åˆ—è¡¨
    await event.reply("ä½ å¥½ï¼è¿™é‡Œæ˜¯ NEO Botã€‚")
```

#### 2. ç›‘å¬é€šçŸ¥äº‹ä»¶

ä½¿ç”¨ `@matcher.on_notice("é€šçŸ¥ç±»å‹")` ç›‘å¬é€šçŸ¥ã€‚

```python
from core.command_manager import matcher
from core.bot import Bot
from models import GroupIncreaseNoticeEvent

# ç›‘å¬ç¾¤æˆå‘˜å¢åŠ äº‹ä»¶
@matcher.on_notice("group_increase")
async def welcome_new_member(bot: Bot, event: GroupIncreaseNoticeEvent):
    await bot.send_group_msg(event.group_id, f"æ¬¢è¿æ–°æˆå‘˜ {event.user_id} åŠ å…¥ï¼")
```

#### 3. ç›‘å¬è¯·æ±‚äº‹ä»¶

ä½¿ç”¨ `@matcher.on_request("è¯·æ±‚ç±»å‹")` ç›‘å¬è¯·æ±‚ã€‚

```python
from core.command_manager import matcher
from core.bot import Bot
from models import FriendRequestEvent

# è‡ªåŠ¨åŒæ„å¥½å‹è¯·æ±‚
@matcher.on_request("friend")
async def auto_approve_friend(bot: Bot, event: FriendRequestEvent):
    await bot.call_api("set_friend_add_request", {
        "flag": event.flag,
        "approve": True
    })
```

#### 4. API è°ƒç”¨æ–¹å¼å¯¹æ¯”

æ¡†æ¶æä¾›ä¸¤ç§ API è°ƒç”¨æ–¹å¼ï¼š**ç±»å‹åŒ– API**ï¼ˆæ¨èï¼‰å’Œ **é€šç”¨ API**ï¼ˆå¤‡ç”¨ï¼‰ã€‚

##### æ–¹å¼ä¸€ï¼šç±»å‹åŒ– APIï¼ˆæ¨èï¼‰
å¯¹äºå·²å°è£…çš„ APIï¼Œæ¡†æ¶æä¾›äº†ç±»å‹åŒ–çš„æ–¹æ³•ï¼Œè¿”å›æ•°æ®æ¨¡å‹å¯¹è±¡è€ŒéåŸå§‹å­—å…¸ï¼š

```python
from core.command_manager import matcher
from core.bot import Bot
from models import MessageEvent
from models.objects import Group

@matcher.command("info")
async def get_group_info_typed(bot: Bot, event: MessageEvent, args: list[str]):
    # ä½¿ç”¨ç±»å‹åŒ– APIï¼Œè¿”å› Group å¯¹è±¡
    group: Group = await bot.get_group_info(event.group_id)
    await event.reply(f"ç¾¤åï¼š{group.group_name}\næˆå‘˜æ•°ï¼š{group.member_count}\nåˆ›å»ºæ—¶é—´ï¼š{group.create_time}")
```

##### æ–¹å¼äºŒï¼šé€šç”¨ APIï¼ˆå¤‡ç”¨ï¼‰
å¦‚æœæ¡†æ¶å°šæœªå°è£…æŸä¸ª OneBot APIï¼Œä½ å¯ä»¥ä½¿ç”¨ `bot.call_api` ç›´æ¥è°ƒç”¨ã€‚è¿™æ˜¯é€šç”¨çš„å¤‡ç”¨è°ƒç”¨æ–¹æ³•ã€‚

```python
from core.command_manager import matcher
from core.bot import Bot
from models import MessageEvent

@matcher.command("info_legacy")
async def get_group_info_legacy(bot: Bot, event: MessageEvent, args: list[str]):
    # ç›´æ¥è°ƒç”¨ get_group_info API
    # action: API åç§°
    # params: API å‚æ•°å­—å…¸
    resp = await bot.call_api("get_group_info", {
        "group_id": event.group_id,
        "no_cache": False
    })
    
    if resp.get("status") == "ok":
        group_name = resp["data"]["group_name"]
        await event.reply(f"å½“å‰ç¾¤åï¼š{group_name}")
```

**å»ºè®®**ï¼šä¼˜å…ˆä½¿ç”¨ç±»å‹åŒ– APIï¼Œè·å¾—æ›´å¥½çš„ç±»å‹å®‰å…¨å’Œä»£ç æç¤ºã€‚ä»…åœ¨æ¡†æ¶æœªå°è£…ç‰¹å®š API æ—¶ä½¿ç”¨é€šç”¨ APIã€‚

## ğŸ“– æ’ä»¶å¼€å‘æŒ‡å—

### æ’ä»¶åŸºæœ¬ç»“æ„
ä¸€ä¸ªæ ‡å‡†çš„æ’ä»¶æ–‡ä»¶åº”è¯¥åŒ…å«ä»¥ä¸‹éƒ¨åˆ†ï¼š
1.  **æ¨¡å—æ–‡æ¡£å­—ç¬¦ä¸²**ï¼šæè¿°æ’ä»¶åŠŸèƒ½
2.  **å¯¼å…¥å¿…è¦çš„æ¨¡å—**ï¼šä» `core` å’Œ `models` å¯¼å…¥æ‰€éœ€ç±»
3.  **ä½¿ç”¨è£…é¥°å™¨æ³¨å†Œäº‹ä»¶å¤„ç†å™¨**ï¼š`@matcher.command()`, `@matcher.on_notice()`, `@matcher.on_request()`
4.  **å¼‚æ­¥å‡½æ•°å®ç°ä¸šåŠ¡é€»è¾‘**ï¼šä½¿ç”¨ `async def` å®šä¹‰å¤„ç†å‡½æ•°

### æ’ä»¶å…ƒæ•°æ® (`__plugin_meta__`)
ä¸ºäº†å®ç°æ’ä»¶çš„è‡ªåŠ¨å‘ç°å’Œå¸®åŠ©ä¿¡æ¯çš„è‡ªåŠ¨ç”Ÿæˆï¼Œæ¡†æ¶å¼•å…¥äº†æ’ä»¶å…ƒæ•°æ®æœºåˆ¶ã€‚ä½ éœ€è¦åœ¨ä½ çš„æ’ä»¶æ¨¡å—ä¸­å®šä¹‰ä¸€ä¸ªåä¸º `__plugin_meta__` çš„å­—å…¸ã€‚

`load_all_plugins` å‡½æ•°åœ¨åŠ è½½æ’ä»¶æ—¶ä¼šè‡ªåŠ¨è¯»å–è¿™ä¸ªå˜é‡ï¼Œå¹¶å°†å…¶æ³¨å†Œåˆ° `CommandManager` ä¸­ã€‚`/help` æŒ‡ä»¤ä¼šéå†æ‰€æœ‰å·²æ³¨å†Œçš„å…ƒæ•°æ®ï¼Œç”Ÿæˆæ ¼å¼åŒ–çš„å¸®åŠ©ä¿¡æ¯ã€‚

ä¸€ä¸ªæ ‡å‡†çš„ `__plugin_meta__` åŒ…å«ä»¥ä¸‹å­—æ®µï¼š

-   `name` (str): æ’ä»¶çš„å‹å¥½åç§°ï¼Œä¾‹å¦‚ "å›å£°"ã€‚
-   `description` (str): å¯¹æ’ä»¶åŠŸèƒ½çš„ç®€çŸ­æè¿°ã€‚
-   `usage` (str): æ’ä»¶çš„ä½¿ç”¨æ–¹æ³•ï¼Œå¯ä»¥åŒ…å«å¤šä¸ªæŒ‡ä»¤å’Œå®ƒä»¬çš„è¯´æ˜ã€‚

**ç¤ºä¾‹ï¼š**
```python
# plugins/echo.py

__plugin_meta__ = {
    "name": "å›å£°ä¸äº¤äº’",
    "description": "æä¾› echo å’Œ èµæˆ‘ åŠŸèƒ½",
    "usage": "/echo [å†…å®¹] - å¤è¯»å†…å®¹\n/èµæˆ‘ - è®©æœºå™¨äººç»™ä½ ç‚¹èµ",
}
```

### ä½¿ç”¨ç±»å‹åŒ– API
æ¡†æ¶ç°å·²æä¾›å®Œæ•´çš„ç±»å‹åŒ– API å°è£…ï¼Œå»ºè®®ä¼˜å…ˆä½¿ç”¨è¿™äº›å°è£…æ–¹æ³•è€ŒéåŸå§‹çš„ `call_api`ï¼š

| API æ–¹æ³• | è¿”å›ç±»å‹ | è¯´æ˜ |
|---------|---------|------|
| `bot.send_group_msg()` | `Message` | å‘é€ç¾¤æ¶ˆæ¯ |
| `bot.get_group_info()` | `Group` | è·å–ç¾¤ä¿¡æ¯ |
| `bot.get_group_member_info()` | `GroupMember` | è·å–ç¾¤æˆå‘˜ä¿¡æ¯ |
| `bot.get_friend_list()` | `List[Friend]` | è·å–å¥½å‹åˆ—è¡¨ |
| `bot.get_login_info()` | `LoginInfo` | è·å–ç™»å½•ä¿¡æ¯ |
| `bot.get_version_info()` | `VersionInfo` | è·å–ç‰ˆæœ¬ä¿¡æ¯ |

#### ç¤ºä¾‹ï¼šä½¿ç”¨ç±»å‹åŒ– API é‡æ„ç¾¤ä¿¡æ¯æŸ¥è¯¢
```python
from core.command_manager import matcher
from core.bot import Bot
from models import MessageEvent
from models.objects import Group

@matcher.command("group_info")
async def get_group_info_typed(bot: Bot, event: MessageEvent, args: list[str]):
    # ä½¿ç”¨ç±»å‹åŒ– APIï¼Œè¿”å› Group å¯¹è±¡è€Œéå­—å…¸
    group: Group = await bot.get_group_info(event.group_id)
    await event.reply(f"ç¾¤åï¼š{group.group_name}\næˆå‘˜æ•°ï¼š{group.member_count}\nåˆ›å»ºæ—¶é—´ï¼š{group.create_time}")
```

### äº‹ä»¶å¤„ç†æ¨¡å¼
é™¤äº†åŸºæœ¬çš„æ¶ˆæ¯æŒ‡ä»¤ï¼Œè¿˜å¯ä»¥å¤„ç†å¤šç§äº‹ä»¶ç±»å‹ï¼š

#### 1. é€šçŸ¥äº‹ä»¶å¤„ç†
```python
from models import GroupCardChangeEvent

@matcher.on_notice("group_card")
async def handle_group_card_change(bot: Bot, event: GroupCardChangeEvent):
    # event.card_new æ˜¯æ–°åç‰‡ï¼Œevent.card_old æ˜¯æ—§åç‰‡
    await bot.send_group_msg(event.group_id, f"æˆå‘˜ {event.user_id} çš„åç‰‡ä» '{event.card_old}' æ”¹ä¸º '{event.card_new}'")
```

#### 2. è¯·æ±‚äº‹ä»¶å¤„ç†
```python
from models import GroupRequestEvent

@matcher.on_request("group")
async def handle_group_request(bot: Bot, event: GroupRequestEvent):
    # æ ¹æ®è¯·æ±‚ç±»å‹å¤„ç†
    if event.sub_type == "add":
        # è‡ªåŠ¨åŒæ„åŠ ç¾¤è¯·æ±‚
        await bot.set_group_add_request(event.flag, event.sub_type, approve=True)
        await bot.send_group_msg(event.group_id, f"å·²åŒæ„ç”¨æˆ· {event.user_id} çš„åŠ ç¾¤è¯·æ±‚")
```

### é”™è¯¯å¤„ç†
å»ºè®®åœ¨æ’ä»¶ä¸­æ·»åŠ é€‚å½“çš„é”™è¯¯å¤„ç†ï¼Œé¿å…å•ä¸ªæ’ä»¶å´©æºƒå½±å“æ•´ä¸ªæœºå™¨äººï¼š

```python
@matcher.command("dangerous")
async def dangerous_command(bot: Bot, event: MessageEvent, args: list[str]):
    try:
        # å¯èƒ½å¤±è´¥çš„æ“ä½œ
        result = await bot.call_api("some_api", {"param": "value"})
        await event.reply(f"æˆåŠŸï¼š{result}")
    except Exception as e:
        await event.reply(f"æ‰§è¡Œå¤±è´¥ï¼š{str(e)}")
        # è®°å½•æ—¥å¿—
        from core.logger import logger
        logger.error(f"æ’ä»¶æ‰§è¡Œé”™è¯¯ï¼š{e}", exc_info=True)
```

### å¤„ç†åŒæ­¥é˜»å¡æ“ä½œ
ä¸ºäº†ä¿æŒæœºå™¨äººçš„å“åº”æ€§ï¼Œæ‰€æœ‰å¯èƒ½å¯¼è‡´é•¿æ—¶é—´é˜»å¡çš„åŒæ­¥æ“ä½œéƒ½åº”è¯¥åœ¨å•ç‹¬çš„çº¿ç¨‹æ± ä¸­æ‰§è¡Œã€‚æ¡†æ¶æä¾›äº† `run_in_thread_pool` å‡½æ•°æ¥ç®€åŒ–è¿™ä¸€è¿‡ç¨‹ã€‚

**ç¤ºä¾‹ï¼šæ‰§è¡ŒåŒæ­¥é˜»å¡ä»»åŠ¡**
```python
from core.command_manager import matcher
from core.bot import Bot
from models import MessageEvent
from core.executor import run_in_thread_pool
import time

# æ¨¡æ‹Ÿä¸€ä¸ªè€—æ—¶çš„åŒæ­¥æ“ä½œ
def blocking_task(duration: int):
    time.sleep(duration)
    return f"é˜»å¡ä»»åŠ¡å®Œæˆï¼Œè€—æ—¶ {duration} ç§’"

@matcher.command("block_test")
async def handle_blocking_test(bot: Bot, event: MessageEvent, args: list[str]):
    if not args or not args[0].isdigit():
        await event.reply("è¯·æä¾›ä¸€ä¸ªæ•°å­—ä½œä¸ºé˜»å¡æ—¶é—´ï¼ˆç§’ï¼‰ã€‚ä¾‹å¦‚ï¼š/block_test 5")
        return
    
    duration = int(args[0])
    await event.reply(f"å¼€å§‹æ‰§è¡Œé˜»å¡ä»»åŠ¡ï¼Œè€—æ—¶ {duration} ç§’...")
    
    # å°†åŒæ­¥é˜»å¡ä»»åŠ¡æ”¾å…¥çº¿ç¨‹æ± æ‰§è¡Œ
    result = await run_in_thread_pool(blocking_task, duration)
    await event.reply(result)
```

### æƒé™ç®¡ç†
æ¡†æ¶å†…ç½®äº†åŸºäºç”¨æˆ·è§’è‰²çš„æƒé™ç®¡ç†ç³»ç»Ÿï¼Œæ”¯æŒ `admin`ï¼ˆè¶…çº§ç®¡ç†å‘˜ï¼‰ã€`op`ï¼ˆæ“ä½œå‘˜ï¼‰ã€`user`ï¼ˆæ™®é€šç”¨æˆ·ï¼‰ä¸‰ä¸ªæƒé™çº§åˆ«ã€‚æƒé™æ•°æ®å­˜å‚¨åœ¨ `data/permissions.json` æ–‡ä»¶ä¸­ã€‚

#### æƒé™çº§åˆ«è¯´æ˜
- **admin**ï¼šæœ€é«˜æƒé™ï¼Œå¯ä»¥æ‰§è¡Œæ‰€æœ‰ç®¡ç†å‘½ä»¤ï¼ŒåŒ…æ‹¬æ·»åŠ /ç§»é™¤å…¶ä»–ç®¡ç†å‘˜
- **op**ï¼šæ“ä½œå‘˜æƒé™ï¼Œå¯ä»¥æ‰§è¡Œå¤§éƒ¨åˆ†ç®¡ç†å‘½ä»¤ï¼Œä½†ä¸èƒ½ä¿®æ”¹ç®¡ç†å‘˜åˆ—è¡¨
- **user**ï¼šæ™®é€šç”¨æˆ·æƒé™ï¼Œåªèƒ½ä½¿ç”¨åŸºç¡€åŠŸèƒ½

#### åœ¨æ’ä»¶ä¸­ä½¿ç”¨æƒé™æ§åˆ¶
æ³¨å†Œå‘½ä»¤æ—¶å¯ä»¥é€šè¿‡ `permission` å‚æ•°æŒ‡å®šæ‰€éœ€æƒé™çº§åˆ«ï¼š

```python
from models import MessageEvent

# åªæœ‰ç®¡ç†å‘˜å¯ä»¥æ‰§è¡Œæ­¤å‘½ä»¤
@matcher.command("admin_only", permission=MessageEvent.ADMIN)
async def admin_command(bot: Bot, event: MessageEvent, args: list[str]):
    await event.reply("æ­¤å‘½ä»¤ä»…é™ç®¡ç†å‘˜ä½¿ç”¨")

# æ“ä½œå‘˜åŠä»¥ä¸Šæƒé™å¯ä»¥æ‰§è¡Œ
@matcher.command("op_only", permission=MessageEvent.OP)
async def op_command(bot: Bot, event: MessageEvent, args: list[str]):
    await event.reply("æ­¤å‘½ä»¤éœ€è¦æ“ä½œå‘˜æƒé™")

# æ‰€æœ‰ç”¨æˆ·éƒ½å¯ä»¥æ‰§è¡Œï¼ˆé»˜è®¤ï¼‰
@matcher.command("public")
async def public_command(bot: Bot, event: MessageEvent, args: list[str]):
    await event.reply("æ‰€æœ‰ç”¨æˆ·éƒ½å¯ä»¥ä½¿ç”¨æ­¤å‘½ä»¤")
```

#### åŠ¨æ€æƒé™æ£€æŸ¥
å¦‚æœéœ€è¦æ›´å¤æ‚çš„æƒé™é€»è¾‘ï¼Œå¯ä»¥ä½¿ç”¨ `override_permission_check=True` å‚æ•°ï¼Œç„¶ååœ¨å‡½æ•°ä¸­æ‰‹åŠ¨æ£€æŸ¥æƒé™ï¼š

```python
@matcher.command(
    "special",
    permission=MessageEvent.OP,
    override_permission_check=True
)
async def special_command(bot: Bot, event: MessageEvent, permission_granted: bool):
    if not permission_granted:
        await event.reply("æƒé™ä¸è¶³ï¼")
        return
    
    # é¢å¤–çš„æƒé™é€»è¾‘
    if event.user_id == 123456:
        await event.reply("ç‰¹æ®Šç”¨æˆ·ï¼Œå…è®¸æ‰§è¡Œ")
    else:
        await event.reply("æ™®é€šç”¨æˆ·ï¼Œæ‹’ç»æ‰§è¡Œ")
```

### ä½¿ç”¨ Redis è¿›è¡Œæ•°æ®ç¼“å­˜
æ¡†æ¶é›†æˆäº† Redis å®¢æˆ·ç«¯ï¼Œæä¾›äº†ä¾¿æ·çš„å¼‚æ­¥æ¥å£ç”¨äºæ•°æ®ç¼“å­˜å’ŒæŒä¹…åŒ–ã€‚Redis è¿æ¥ç®¡ç†å™¨ä¼šè‡ªåŠ¨ç®¡ç†è¿æ¥æ± ï¼Œä½ å¯ä»¥åœ¨æ’ä»¶ä¸­ç›´æ¥ä½¿ç”¨ã€‚

#### åŸºæœ¬ç”¨æ³•
```python
from core.redis_manager import redis_manager

@matcher.command("cache")
async def cache_example(bot: Bot, event: MessageEvent, args: list[str]):
    # è®¾ç½®ç¼“å­˜
    await redis_manager.set("user:123:name", "å¼ ä¸‰")
    
    # è·å–ç¼“å­˜
    name = await redis_manager.get("user:123:name")
    
    # è®¾ç½®å¸¦è¿‡æœŸæ—¶é—´çš„ç¼“å­˜ï¼ˆå•ä½ï¼šç§’ï¼‰
    await redis_manager.setex("temp:data", 3600, "ä¸´æ—¶æ•°æ®")
    
    # åˆ é™¤ç¼“å­˜
    await redis_manager.delete("user:123:name")
    
    await event.reply(f"ç”¨æˆ·åï¼š{name}")
```

#### ä½¿ç”¨å“ˆå¸Œè¡¨ï¼ˆHashï¼‰
```python
# è®¾ç½®å“ˆå¸Œå­—æ®µ
await redis_manager.hset("user:123", "age", 20)
await redis_manager.hset("user:123", "city", "åŒ—äº¬")

# è·å–å“ˆå¸Œå­—æ®µ
age = await redis_manager.hget("user:123", "age")
user_data = await redis_manager.hgetall("user:123")

# åˆ é™¤å“ˆå¸Œå­—æ®µ
await redis_manager.hdel("user:123", "city")
```

#### ä½¿ç”¨åˆ—è¡¨ï¼ˆListï¼‰
```python
# å‘åˆ—è¡¨æ·»åŠ å…ƒç´ 
await redis_manager.lpush("recent:actions", "login")
await redis_manager.rpush("recent:actions", "logout")

# è·å–åˆ—è¡¨èŒƒå›´
actions = await redis_manager.lrange("recent:actions", 0, 9)

# è·å–åˆ—è¡¨é•¿åº¦
length = await redis_manager.llen("recent:actions")
```

### æ’ä»¶æ•°æ®ç®¡ç†
å¯¹äºéœ€è¦æŒä¹…åŒ–å­˜å‚¨é…ç½®æˆ–æ•°æ®çš„æ’ä»¶ï¼Œæ¡†æ¶æä¾›äº† `PluginDataManager` ç±»ï¼Œå¯ä»¥æ–¹ä¾¿åœ°ç®¡ç† JSON æ ¼å¼çš„æ•°æ®æ–‡ä»¶ã€‚

#### åŸºæœ¬ç”¨æ³•
```python
from core.plugin_manager import PluginDataManager

# åˆå§‹åŒ–æ•°æ®ç®¡ç†å™¨
data_manager = PluginDataManager("weather_plugin")

@matcher.command("weather_set")
async def set_weather_config(bot: Bot, event: MessageEvent, args: list[str]):
    if len(args) < 2:
        await event.reply("ç”¨æ³•ï¼š/weather_set <åŸå¸‚> <æ¸©åº¦>")
        return
    
    city = args[0]
    temperature = args[1]
    
    # ä¿å­˜é…ç½®
    await data_manager.set(city, temperature)
    await event.reply(f"å·²è®¾ç½® {city} çš„æ¸©åº¦ä¸º {temperature}â„ƒ")

@matcher.command("weather_get")
async def get_weather_config(bot: Bot, event: MessageEvent, args: list[str]):
    if not args:
        await event.reply("ç”¨æ³•ï¼š/weather_get <åŸå¸‚>")
        return
    
    city = args[0]
    
    # è¯»å–é…ç½®
    temperature = data_manager.get(city)
    if temperature:
        await event.reply(f"{city} çš„æ¸©åº¦æ˜¯ {temperature}â„ƒ")
    else:
        await event.reply(f"æœªæ‰¾åˆ° {city} çš„æ¸©åº¦é…ç½®")
```

#### æ•°æ®æ–‡ä»¶ä½ç½®
æ’ä»¶æ•°æ®æ–‡ä»¶ä¿å­˜åœ¨ `plugins/data/` ç›®å½•ä¸‹ï¼Œæ¯ä¸ªæ’ä»¶å¯¹åº”ä¸€ä¸ªç‹¬ç«‹çš„ JSON æ–‡ä»¶ã€‚ä¾‹å¦‚ `weather_plugin` æ’ä»¶çš„æ•°æ®æ–‡ä»¶ä¸º `plugins/data/weather_plugin.json`ã€‚

### æ’ä»¶å¼€å‘æœ€ä½³å®è·µ
1.  **å•ä¸€èŒè´£**ï¼šæ¯ä¸ªæ’ä»¶ä¸“æ³¨äºä¸€ä¸ªåŠŸèƒ½é¢†åŸŸ
2.  **é”™è¯¯å¤„ç†**ï¼šå¦¥å–„å¤„ç†å¯èƒ½å‘ç”Ÿçš„å¼‚å¸¸
3.  **ç±»å‹æç¤º**ï¼šä¸ºå‡½æ•°å‚æ•°å’Œè¿”å›å€¼æ·»åŠ ç±»å‹æç¤º
4.  **æ–‡æ¡£å®Œæ•´**ï¼šä¸ºæ¯ä¸ªå‡½æ•°æ·»åŠ æ–‡æ¡£å­—ç¬¦ä¸²
5.  **æ€§èƒ½è€ƒè™‘**ï¼šé¿å…åœ¨æ’ä»¶ä¸­æ‰§è¡Œè€—æ—¶åŒæ­¥æ“ä½œ
6.  **èµ„æºæ¸…ç†**ï¼šå¿…è¦æ—¶ä½¿ç”¨ `try...finally` ç¡®ä¿èµ„æºé‡Šæ”¾

### ğŸš€ é«˜æ€§èƒ½æ’ä»¶å¼€å‘è§„èŒƒ (é¿å‘æŒ‡å—)
ä¸ºäº†ä¿è¯æ•´ä¸ªæœºå™¨äººæ¡†æ¶çš„å“åº”é€Ÿåº¦å’Œç¨³å®šæ€§ï¼Œæ‰€æœ‰æ’ä»¶éƒ½å¿…é¡»éµå¾ªå¼‚æ­¥ã€éé˜»å¡çš„å¼€å‘åŸåˆ™ã€‚ä»»ä½•ä¸€ä¸ªæ’ä»¶ä¸­çš„é˜»å¡æ“ä½œéƒ½å¯èƒ½å¯¼è‡´æ•´ä¸ªæœºå™¨äººå¡é¡¿æˆ–æ— å“åº”ã€‚

ä»¥ä¸‹æ˜¯å¿…é¡»éµå®ˆçš„æ ¸å¿ƒè§„èŒƒï¼š

#### 1. ç¦æ­¢ä»»ä½•å½¢å¼çš„åŒæ­¥ç½‘ç»œè¯·æ±‚
- **é”™è¯¯ç¤ºèŒƒ**: ä½¿ç”¨ `requests` åº“å‘èµ·ç½‘ç»œè¯·æ±‚ã€‚
  ```python
  import requests
  # é”™è¯¯ï¼è¿™ä¼šé˜»å¡æ•´ä¸ªç¨‹åº
  response = requests.get("https://api.example.com") 
  ```
- **æ­£ç¡®åšæ³•**: å¿…é¡»ä½¿ç”¨å¼‚æ­¥ HTTP å®¢æˆ·ç«¯ï¼Œå¦‚ `aiohttp` æˆ– `httpx`ã€‚
  ```python
  import httpx
  # æ­£ç¡®ï¼Œä½¿ç”¨ async with å’Œ await
  async with httpx.AsyncClient() as client:
      response = await client.get("https://api.example.com")
  ```

#### 2. ç¦æ­¢ä½¿ç”¨ `time.sleep()`
- **é”™è¯¯ç¤ºèŒƒ**: ä½¿ç”¨ `time.sleep()` è¿›è¡Œç­‰å¾…ã€‚
  ```python
  import time
  # é”™è¯¯ï¼è¿™ä¼šé˜»å¡äº‹ä»¶å¾ªç¯
  time.sleep(5)
  ```
- **æ­£ç¡®åšæ³•**: å¿…é¡»ä½¿ç”¨ `asyncio.sleep()`ã€‚
  ```python
  import asyncio
  # æ­£ç¡®ï¼Œè¿™ä¼šå°†æ§åˆ¶æƒäº¤è¿˜ç»™äº‹ä»¶å¾ªç¯
  await asyncio.sleep(5)
  ```

#### 3. è°¨æ…å¤„ç†æ–‡ä»¶ I/O
- å¯¹äºè¯»å†™å°å‹ã€æœ¬åœ°æ–‡ä»¶ï¼Œç›´æ¥ä½¿ç”¨ `with open(...)` é€šå¸¸æ˜¯å¯æ¥å—çš„ã€‚
- ä½†å¯¹äºå¤§å‹æ–‡ä»¶æˆ–ç½‘ç»œæ–‡ä»¶ç³»ç»Ÿï¼ˆNFSï¼‰ä¸Šçš„æ–‡ä»¶ï¼ŒåŒæ­¥ I/O å¯èƒ½ä¼šå¯¼è‡´æ˜æ˜¾çš„é˜»å¡ã€‚
- **æ¨èåšæ³•**: å¯¹äºå¯èƒ½è€—æ—¶è¾ƒé•¿çš„æ–‡ä»¶æ“ä½œï¼Œä½¿ç”¨ `aiofiles` åº“ã€‚
  ```python
  import aiofiles
  async with aiofiles.open('large_file.dat', mode='rb') as f:
      contents = await f.read()
  ```

#### 4. å°† CPU å¯†é›†å‹ä»»åŠ¡ç§»å‡ºäº‹ä»¶å¾ªç¯
- å¦‚æœæ’ä»¶éœ€è¦æ‰§è¡Œå¤æ‚çš„è®¡ç®—ï¼ˆä¾‹å¦‚ï¼Œå›¾åƒå¤„ç†ã€è§†é¢‘è½¬ç ã€æ•°æ®åˆ†æï¼‰ï¼Œè¿™äº›ä»»åŠ¡ä¼šé•¿æ—¶é—´å ç”¨ CPUï¼ŒåŒæ ·ä¼šé˜»å¡äº‹ä»¶å¾ªç¯ã€‚
- **æ­£ç¡®åšæ³•**: ä½¿ç”¨ `loop.run_in_executor()` å°†è¿™ç±»ä»»åŠ¡æŠ›åˆ°ç‹¬ç«‹çš„çº¿ç¨‹æ± æˆ–è¿›ç¨‹æ± ä¸­æ‰§è¡Œã€‚
  ```python
  import asyncio

  def cpu_bound_task(data):
      # è¿™æ˜¯ä¸€ä¸ªè€—æ—¶çš„åŒæ­¥å‡½æ•°
      # ... è¿›è¡Œå¤§é‡è®¡ç®— ...
      return "è®¡ç®—ç»“æœ"

  # åœ¨å¼‚æ­¥çš„äº‹ä»¶å¤„ç†å™¨ä¸­è°ƒç”¨
  loop = asyncio.get_running_loop()
  # `None` è¡¨ç¤ºä½¿ç”¨é»˜è®¤çš„çº¿ç¨‹æ± 
  result = await loop.run_in_executor(None, cpu_bound_task, "ä¸€äº›æ•°æ®")
  await event.reply(result)
  ```

éµå¾ªä»¥ä¸Šè§„èŒƒï¼Œå¯ä»¥ç¡®ä¿æ‚¨å¼€å‘çš„æ’ä»¶ä¸ä¼šæˆä¸ºæ•´ä¸ªæœºå™¨äººåº”ç”¨çš„æ€§èƒ½ç“¶é¢ˆã€‚

### ç¤ºä¾‹ï¼šå®Œæ•´æ’ä»¶æ¨¡æ¿
```python
"""
å¤©æ°”æŸ¥è¯¢æ’ä»¶

æä¾› /weather æŒ‡ä»¤ï¼ŒæŸ¥è¯¢æŒ‡å®šåŸå¸‚çš„å¤©æ°”ä¿¡æ¯ã€‚
"""
from core.command_manager import matcher
from core.bot import Bot
from models import MessageEvent

# æ’ä»¶å…ƒæ•°æ®ï¼Œç”¨äº help æŒ‡ä»¤
__plugin_meta__ = {
    "name": "å¤©æ°”æŸ¥è¯¢",
    "description": "æŸ¥è¯¢æŒ‡å®šåŸå¸‚çš„å¤©æ°”ä¿¡æ¯",
    "usage": "/weather [åŸå¸‚åç§°]",
}

@matcher.command("weather")
async def handle_weather(bot: Bot, event: MessageEvent, args: list[str]):
    """
    æŸ¥è¯¢å¤©æ°”ä¿¡æ¯

    :param bot: Bot å®ä¾‹
    :param event: æ¶ˆæ¯äº‹ä»¶å¯¹è±¡
    :param args: æŒ‡ä»¤å‚æ•°åˆ—è¡¨ï¼ˆåŸå¸‚åç§°ï¼‰
    """
    if not args:
        await event.reply("è¯·è¾“å…¥åŸå¸‚åç§°ï¼Œä¾‹å¦‚ï¼š/weather åŒ—äº¬")
        return

    city = " ".join(args)
    try:
        # è¿™é‡Œå¯ä»¥è°ƒç”¨å¤©æ°” API
        weather_info = f"{city} çš„å¤©æ°”ï¼šæ™´ï¼Œ25â„ƒ"
        await event.reply(weather_info)
    except Exception as e:
        await event.reply(f"æŸ¥è¯¢å¤©æ°”å¤±è´¥ï¼š{str(e)}")

# å¯ä»¥æ³¨å†Œå¤šä¸ªäº‹ä»¶å¤„ç†å™¨
@matcher.on_notice("group_increase")
async def welcome_new_member(bot: Bot, event):
    await bot.send_group_msg(event.group_id, f"æ¬¢è¿æ–°æˆå‘˜ {event.user_id} åŠ å…¥ï¼")
```

## ğŸ“š äº‹ä»¶æ¨¡å‹è¯´æ˜

NEO æ¡†æ¶çš„äº‹ä»¶æ¨¡å‹æ˜¯åŸºäº OneBot v11 åè®®çš„å¼ºç±»å‹æ•°æ®æ¨¡å‹ï¼Œé‡‡ç”¨ `dataclasses` å’Œç±»å‹æ³¨è§£æ„å»ºã€‚æ‰€æœ‰äº‹ä»¶éƒ½ç»§æ‰¿è‡ª `OneBotEvent` åŸºç±»ï¼Œå¹¶é€šè¿‡äº‹ä»¶å·¥å‚è‡ªåŠ¨ä» JSON æ•°æ®åˆ›å»ºå¯¹åº”çš„äº‹ä»¶å¯¹è±¡ã€‚

### äº‹ä»¶å±‚æ¬¡ç»“æ„

```
OneBotEvent (æŠ½è±¡åŸºç±»)
â”œâ”€â”€ MetaEvent (å…ƒäº‹ä»¶)
â”‚   â”œâ”€â”€ HeartbeatEvent (å¿ƒè·³äº‹ä»¶)
â”‚   â””â”€â”€ LifeCycleEvent (ç”Ÿå‘½å‘¨æœŸäº‹ä»¶)
â”œâ”€â”€ MessageEvent (æ¶ˆæ¯äº‹ä»¶)
â”‚   â”œâ”€â”€ PrivateMessageEvent (ç§èŠæ¶ˆæ¯äº‹ä»¶)
â”‚   â””â”€â”€ GroupMessageEvent (ç¾¤èŠæ¶ˆæ¯äº‹ä»¶)
â”œâ”€â”€ NoticeEvent (é€šçŸ¥äº‹ä»¶)
â”‚   â”œâ”€â”€ FriendAddNoticeEvent (å¥½å‹æ·»åŠ é€šçŸ¥)
â”‚   â”œâ”€â”€ FriendRecallNoticeEvent (å¥½å‹æ¶ˆæ¯æ’¤å›é€šçŸ¥)
â”‚   â”œâ”€â”€ GroupRecallNoticeEvent (ç¾¤æ¶ˆæ¯æ’¤å›é€šçŸ¥)
â”‚   â”œâ”€â”€ GroupIncreaseNoticeEvent (ç¾¤æˆå‘˜å¢åŠ é€šçŸ¥)
â”‚   â”œâ”€â”€ GroupDecreaseNoticeEvent (ç¾¤æˆå‘˜å‡å°‘é€šçŸ¥)
â”‚   â”œâ”€â”€ GroupAdminNoticeEvent (ç¾¤ç®¡ç†å‘˜å˜åŠ¨é€šçŸ¥)
â”‚   â”œâ”€â”€ GroupBanNoticeEvent (ç¾¤ç¦è¨€é€šçŸ¥)
â”‚   â”œâ”€â”€ GroupUploadNoticeEvent (ç¾¤æ–‡ä»¶ä¸Šä¼ é€šçŸ¥)
â”‚   â”œâ”€â”€ PokeNotifyEvent (æˆ³ä¸€æˆ³é€šçŸ¥)
â”‚   â”œâ”€â”€ LuckyKingNotifyEvent (è¿æ°”ç‹é€šçŸ¥)
â”‚   â”œâ”€â”€ HonorNotifyEvent (ç¾¤è£èª‰å˜æ›´é€šçŸ¥)
â”‚   â”œâ”€â”€ GroupCardNoticeEvent (ç¾¤æˆå‘˜åç‰‡æ›´æ–°é€šçŸ¥)
â”‚   â”œâ”€â”€ OfflineFileNoticeEvent (ç¦»çº¿æ–‡ä»¶é€šçŸ¥)
â”‚   â”œâ”€â”€ ClientStatusNoticeEvent (å®¢æˆ·ç«¯çŠ¶æ€å˜æ›´é€šçŸ¥)
â”‚   â””â”€â”€ EssenceNoticeEvent (ç²¾åæ¶ˆæ¯å˜åŠ¨é€šçŸ¥)
â””â”€â”€ RequestEvent (è¯·æ±‚äº‹ä»¶)
    â”œâ”€â”€ FriendRequestEvent (åŠ å¥½å‹è¯·æ±‚)
    â””â”€â”€ GroupRequestEvent (åŠ ç¾¤è¯·æ±‚/é‚€è¯·)
```

### äº‹ä»¶åŸºç±»ï¼šOneBotEvent

æ‰€æœ‰äº‹ä»¶çš„åŸºç±»ï¼Œå®šä¹‰äº†äº‹ä»¶çš„é€šç”¨å±æ€§å’Œæ–¹æ³•ï¼š

```python
@dataclass(slots=True)
class OneBotEvent(ABC):
    """
    OneBot v11 äº‹ä»¶çš„æŠ½è±¡åŸºç±»ã€‚
    
    Attributes:
        time (int): äº‹ä»¶å‘ç”Ÿçš„æ—¶é—´æˆ³ (ç§’)
        self_id (int): æ”¶åˆ°äº‹ä»¶çš„æœºå™¨äºº QQ å·
        _bot (Optional[Bot]): å†…éƒ¨æŒæœ‰çš„ Bot å®ä¾‹å¼•ç”¨
    """
    time: int
    self_id: int
    _bot: Optional["Bot"] = field(default=None, init=False)
    
    @property
    @abstractmethod
    def post_type(self) -> str:
        """äº‹ä»¶çš„ä¸ŠæŠ¥ç±»å‹ï¼Œå­ç±»å¿…é¡»é‡å†™æ­¤å±æ€§"""
        pass
    
    @property
    def bot(self) -> "Bot":
        """è·å–ä¸æ­¤äº‹ä»¶å…³è”çš„ Bot å®ä¾‹"""
        if self._bot is None:
            raise ValueError("Bot instance not set for this event")
        return self._bot
    
    @bot.setter
    def bot(self, value: "Bot"):
        """ä¸ºäº‹ä»¶å¯¹è±¡è®¾ç½®å…³è”çš„ Bot å®ä¾‹"""
        self._bot = value
```

### äº‹ä»¶ç±»å‹å¸¸é‡

æ¡†æ¶å®šä¹‰äº†å®Œæ•´çš„äº‹ä»¶ç±»å‹å¸¸é‡ï¼Œç”¨äºæ ‡è¯†ä¸åŒç§ç±»çš„äº‹ä»¶ï¼š

```python
class EventType:
    META = 'meta_event'        # å…ƒäº‹ä»¶ï¼šå¿ƒè·³ã€ç”Ÿå‘½å‘¨æœŸç­‰
    REQUEST = 'request       ' # è¯·æ±‚äº‹ä»¶ï¼šåŠ å¥½å‹è¯·æ±‚ã€åŠ ç¾¤è¯·æ±‚ç­‰
    NOTICE = 'notice'          # é€šçŸ¥äº‹ä»¶ï¼šç¾¤æˆå‘˜å¢åŠ ã€æ–‡ä»¶ä¸Šä¼ ç­‰
    MESSAGE = 'message'        # æ¶ˆæ¯äº‹ä»¶ï¼šç§èŠæ¶ˆæ¯ã€ç¾¤æ¶ˆæ¯ç­‰
    MESSAGE_SENT = 'message_sent'  # æ¶ˆæ¯å‘é€äº‹ä»¶ï¼šæœºå™¨äººè‡ªå·±å‘é€æ¶ˆæ¯çš„ä¸ŠæŠ¥
```

### æ¶ˆæ¯äº‹ä»¶

æ¶ˆæ¯äº‹ä»¶æ˜¯æœºå™¨äººæœ€å¸¸å¤„ç†çš„äº‹ä»¶ç±»å‹ï¼Œæ¡†æ¶æä¾›äº†å®Œæ•´çš„æ¶ˆæ¯æ®µæ”¯æŒå’Œä¾¿æ·çš„å›å¤æ–¹æ³•ï¼š

#### MessageEvent (æ¶ˆæ¯äº‹ä»¶åŸºç±»)

```python
@dataclass
class MessageEvent(OneBotEvent):
    message_type: str          # æ¶ˆæ¯ç±»å‹: private (ç§èŠ), group (ç¾¤èŠ)
    sub_type: str              # æ¶ˆæ¯å­ç±»å‹
    message_id: int            # æ¶ˆæ¯ ID
    user_id: int               # å‘é€è€… QQ å·
    message: List[MessageSegment]  # æ¶ˆæ¯å†…å®¹åˆ—è¡¨
    raw_message: str           # åŸå§‹æ¶ˆæ¯å†…å®¹
    font: int                  # å­—ä½“
    sender: Optional[Sender] #   å‘é€è€…ä¿¡æ¯
    
    @property
    def post_type(self) -> str:
        return EventType.MESSAGE
    
    async def reply(self, message: str, auto_escape: bool = False):
        """å›å¤æ¶ˆæ¯ï¼ˆæŠ½è±¡æ–¹æ³•ï¼Œç”±å­ç±»å®ç°ï¼‰"""
        raise NotImplementedError
```

#### PrivateMessageEvent (ç§èŠæ¶ˆæ¯äº‹ä»¶)

```python
@dataclass
class PrivateMessageEvent(MessageEvent):
    async def reply(self, message: str, auto_escape: bool = False):
        """å›å¤ç§èŠæ¶ˆæ¯"""
        await self.bot.send_private_msg(
            user_id=self.user_id, message=message, auto_escape=auto_escape
        )
```

#### GroupMessageEvent (ç¾¤èŠæ¶ˆæ¯äº‹ä»¶)

```python
@dataclass
class GroupMessageEvent(MessageEvent):
    group_id: int = 0                     # ç¾¤å·
    anonymous: Optional[Anonymous] = None # åŒ¿åä¿¡æ¯
    
    async def reply(self, message: str, auto_escape: bool = False):
        """å›å¤ç¾¤èŠæ¶ˆæ¯"""
        await self.bot.send_group_msg(
            group_id=self.group_id, message=message, auto_escape=auto_escape
        )
```

### é€šçŸ¥äº‹ä»¶

é€šçŸ¥äº‹ä»¶ç”¨äºå¤„ç†å„ç§ç³»ç»Ÿé€šçŸ¥ï¼Œå¦‚ç¾¤æˆå‘˜å˜åŠ¨ã€æ–‡ä»¶ä¸Šä¼ ç­‰ï¼š

#### å¸¸ç”¨é€šçŸ¥äº‹ä»¶ç¤ºä¾‹

```python
@dataclass
class GroupIncreaseNoticeEvent(GroupNoticeEvent):
    """ç¾¤æˆå‘˜å¢åŠ é€šçŸ¥"""
    operator_id: int = 0      # æ“ä½œè€… QQ å·
    sub_type: str = ""        # å­ç±»å‹: approve (ç®¡ç†å‘˜åŒæ„å…¥ç¾¤), invite (ç®¡ç†å‘˜é‚€è¯·å…¥ç¾¤)

@dataclass
class GroupRecallNoticeEvent(GroupNoticeEvent):
    """ç¾¤æ¶ˆæ¯æ’¤å›é€šçŸ¥"""
    operator_id: int = 0      # æ“ä½œè€… QQ å·
    message_id: int = 0       # è¢«æ’¤å›çš„æ¶ˆæ¯ ID

@dataclass
class PokeNotifyEvent(NotifyNoticeEvent):
    """æˆ³ä¸€æˆ³é€šçŸ¥"""
    target_id: int = 0        # è¢«æˆ³è€… QQ å·
    group_id: int = 0         # ç¾¤å· (å¦‚æœæ˜¯ç¾¤å†…æˆ³ä¸€æˆ³)
```

### è¯·æ±‚äº‹ä»¶

è¯·æ±‚äº‹ä»¶ç”¨äºå¤„ç†ç”¨æˆ·çš„ä¸»åŠ¨è¯·æ±‚ï¼Œå¦‚åŠ å¥½å‹ã€åŠ ç¾¤ç­‰ï¼š

```python
@dataclass
class FriendRequestEvent(RequestEvent):
    """åŠ å¥½å‹è¯·æ±‚äº‹ä»¶"""
    user_id: int = 0          # å‘é€è¯·æ±‚çš„ QQ å·
    comment: str = ""         # éªŒè¯ä¿¡æ¯
    flag: str = ""            # è¯·æ±‚ flagï¼Œç”¨äº API è°ƒç”¨

@dataclass
class GroupRequestEvent(RequestEvent):
    """åŠ ç¾¤è¯·æ±‚/é‚€è¯·äº‹ä»¶"""
    sub_type: str = ""        # å­ç±»å‹: add (åŠ ç¾¤è¯·æ±‚), invite (é‚€è¯·ç™»å½•å·å…¥ç¾¤)
    group_id: int = 0         # ç¾¤å·
    user_id: int = 0          # å‘é€è¯·æ±‚çš„ QQ å·
    comment: str = ""         # éªŒè¯ä¿¡æ¯
    flag: str = ""            # è¯·æ±‚ flagï¼Œç”¨äº API è°ƒç”¨
```

### å…ƒäº‹ä»¶

å…ƒäº‹ä»¶ç”¨äºå¤„ç†æ¡†æ¶è‡ªèº«çŠ¶æ€å˜åŒ–ï¼Œå¦‚å¿ƒè·³ã€ç”Ÿå‘½å‘¨æœŸç­‰ï¼š

```python
@dataclass
class HeartbeatEvent(MetaEvent):
    """å¿ƒè·³äº‹ä»¶ï¼Œç”¨äºç¡®è®¤è¿æ¥çŠ¶æ€"""
    meta_event_type: str = 'heartbeat'
    status: HeartbeatStatus = field(default_factory=HeartbeatStatus)
    interval: int = 0         # å¿ƒè·³é—´éš”æ—¶é—´(ms)

@dataclass
class LifeCycleEvent(MetaEvent):
    """ç”Ÿå‘½å‘¨æœŸäº‹ä»¶ï¼Œç”¨äºé€šçŸ¥æ¡†æ¶ç”Ÿå‘½å‘¨æœŸå˜åŒ–"""
    meta_event_type: str = 'lifecycle'
    sub_type: LifeCycleSubType = LifeCycleSubType.ENABLE  # å­ç±»å‹: enable, disable, connect
```

### äº‹ä»¶å·¥å‚ï¼šEventFactory

äº‹ä»¶å·¥å‚æ˜¯æ¡†æ¶çš„æ ¸å¿ƒç»„ä»¶ä¹‹ä¸€ï¼Œè´Ÿè´£å°†åŸå§‹ JSON æ•°æ®è½¬æ¢ä¸ºå¼ºç±»å‹çš„äº‹ä»¶å¯¹è±¡ï¼š

```python
class EventFactory:
    @staticmethod
    def create_event(data: Dict[str, Any]) -> OneBotEvent:
        """æ ¹æ®æ•°æ®åˆ›å»ºäº‹ä»¶å¯¹è±¡"""
        post_type = data.get("post_type")
        
        if post_type == EventType.MESSAGE or post_type == EventType.MESSAGE_SENT:
            return EventFactory._create_message_event(data, common_args)
        elif post_type == EventType.NOTICE:
            return EventFactory._create_notice_event(data, common_args)
        elif post_type == EventType.REQUEST:
            return EventFactory._create_request_event(data, common_args)
        elif post_type == EventType.META:
            return EventFactory._create_meta_event(data, common_args)
        else:
            raise ValueError(f"Unknown event type: {post_type}")
```

### åœ¨æ’ä»¶ä¸­ä½¿ç”¨äº‹ä»¶

æ’ä»¶å¯ä»¥ç›´æ¥ä½¿ç”¨è¿™äº›äº‹ä»¶ç±»å‹æ¥å¤„ç†å„ç§åœºæ™¯ï¼š

```python
from core.command_manager import matcher
from core.bot import Bot
from models import GroupMessageEvent, PrivateMessageEvent
from models.events.notice import GroupIncreaseNoticeEvent
from models.events.request import FriendRequestEvent

# å¤„ç†ç¾¤æ¶ˆæ¯äº‹ä»¶
@matcher.command("hello")
async def handle_hello(bot: Bot, event: GroupMessageEvent, args: list[str]):
    await event.reply(f"ä½ å¥½ {event.sender.nickname}ï¼")

# å¤„ç†ç§èŠæ¶ˆæ¯äº‹ä»¶
@matcher.command("help", permission_level=MessageEvent.USER)
async def handle_help(bot: Bot, event: PrivateMessageEvent, args: list[str]):
    await event.reply("è¿™é‡Œæ˜¯å¸®åŠ©ä¿¡æ¯...")

# å¤„ç†ç¾¤æˆå‘˜å¢åŠ é€šçŸ¥
@matcher.on_notice("group_increase")
async def handle_group_increase(bot: Bot, event: GroupIncreaseNoticeEvent):
    await bot.send_group_msg(
        event.group_id, 
        f"æ¬¢è¿æ–°æˆå‘˜ {event.user_id} åŠ å…¥ï¼æ“ä½œè€…ï¼š{event.operator_id}"
    )

# å¤„ç†åŠ å¥½å‹è¯·æ±‚
@matcher.on_request("friend")
async def handle_friend_request(bot: Bot, event: FriendRequestEvent):
    # è‡ªåŠ¨åŒæ„æ‰€æœ‰å¥½å‹è¯·æ±‚
    await bot.set_friend_add_request(flag=event.flag, approve=True)
    await bot.send_private_msg(event.user_id, "å·²é€šè¿‡æ‚¨çš„å¥½å‹è¯·æ±‚ï¼")
```

### äº‹ä»¶å¤„ç†çš„ä¼˜åŠ¿

1. **ç±»å‹å®‰å…¨**ï¼šæ‰€æœ‰äº‹ä»¶éƒ½æœ‰æ˜ç¡®çš„ç±»å‹å®šä¹‰ï¼ŒIDE å¯ä»¥æä¾›å®Œæ•´çš„ä»£ç æç¤ºå’Œè¡¥å…¨
2. **æ˜“äºæµ‹è¯•**ï¼šäº‹ä»¶å¯¹è±¡å¯ä»¥è½»æ¾æ„é€ ï¼Œä¾¿äºç¼–å†™å•å…ƒæµ‹è¯•
3. **æ•°æ®å®Œæ•´**ï¼šæ‰€æœ‰å­—æ®µéƒ½æœ‰ç±»å‹æ³¨è§£ï¼Œç¡®ä¿æ•°æ®çš„ä¸€è‡´æ€§å’Œå®Œæ•´æ€§
4. **æ€§èƒ½ä¼˜åŒ–**ï¼šä½¿ç”¨ `@dataclass(slots=True)` å‡å°‘å†…å­˜å ç”¨ï¼Œæé«˜å±æ€§è®¿é—®é€Ÿåº¦
5. **å¯æ‰©å±•æ€§**ï¼šå¯ä»¥è½»æ¾å®šä¹‰è‡ªå®šä¹‰äº‹ä»¶ç±»å‹ï¼Œæ‰©å±•æ¡†æ¶åŠŸèƒ½

### å¸¸ç”¨äº‹ä»¶å±æ€§é€ŸæŸ¥

| äº‹ä»¶ç±»å‹ | å…³é”®å±æ€§ | æè¿° |
|---------|---------|------|
| **MessageEvent** | `message_type`, `user_id`, `message`, `sender` | æ‰€æœ‰æ¶ˆæ¯äº‹ä»¶çš„åŸºç±» |
| **PrivateMessageEvent** | ç»§æ‰¿è‡ª MessageEvent | ç§èŠæ¶ˆæ¯äº‹ä»¶ |
| **GroupMessageEvent** | `group_id`, `anonymous` | ç¾¤èŠæ¶ˆæ¯äº‹ä»¶ï¼ŒåŒ…å«ç¾¤å·å’ŒåŒ¿åä¿¡æ¯ |
| **GroupIncreaseNoticeEvent** | `group_id`, `user_id`, `operator_id`, `sub_type` | ç¾¤æˆå‘˜å¢åŠ é€šçŸ¥ |
| **RecallGroupNoticeEvent** | `group_id`, `user_id`, `operator_id`, `message_id` | ç¾¤æ¶ˆæ¯æ’¤å›é€šçŸ¥ |
| **FriendRequestEvent** | `user_id`, `comment`, `flag` | åŠ å¥½å‹è¯·æ±‚äº‹ä»¶ |
| **GroupRequestEvent** | `group_id`, `user_id`, `sub_type`, `comment`, `flag` | åŠ ç¾¤è¯·æ±‚/é‚€è¯·äº‹ä»¶ |
| **HeartbeatEvent** | `status`, `interval` | å¿ƒè·³äº‹ä»¶ï¼Œç”¨äºç›‘æ§è¿æ¥çŠ¶æ€ |

é€šè¿‡è¿™å¥—å®Œæ•´çš„äº‹ä»¶æ¨¡å‹ï¼ŒNEO æ¡†æ¶ä¸ºå¼€å‘è€…æä¾›äº†å¼ºå¤§è€Œçµæ´»çš„äº‹ä»¶å¤„ç†èƒ½åŠ›ï¼ŒåŒæ—¶ä¿æŒäº†ä»£ç çš„ç±»å‹å®‰å…¨å’Œè‰¯å¥½çš„å¼€å‘ä½“éªŒã€‚
